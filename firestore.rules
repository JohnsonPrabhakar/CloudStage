
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check for Admin role
    function isAdmin() {
      return request.auth != null && request.auth.token.email == 'admin@cloudstage.in';
    }

    match /artists/{artistId} {
      // Anyone can read an artist's profile
      allow read: if true;
      // Only the authenticated artist OR an admin can update their profile.
      allow update: if request.auth.uid == artistId || isAdmin();
      // Only an authenticated user can create an artist profile for themselves.
      // Admins cannot create profiles on behalf of others via this rule.
      allow create: if request.auth.uid == artistId;
      // Only an admin can delete an artist profile.
      allow delete: if isAdmin();
    }

    match /events/{eventId} {
      // Anyone can read an event document.
      allow read: if true;
      // An event can only be created by the authenticated artist who owns it.
      allow create: if request.auth.uid == request.resource.data.artistId;
      // An event can be updated by its owner OR by an admin (for moderation).
      allow update: if request.auth.uid == resource.data.artistId || isAdmin();
      // An event can be deleted only by its owner.
      allow delete: if request.auth.uid == resource.data.artistId;
    }
    
    match /movies/{movieId} {
      // Anyone can read movie documents.
      allow read: if true;
      // Only admins can create, update, or delete movies.
      allow write: if isAdmin();
    }

    match /tickets/{ticketId} {
      // A ticket can be created by any authenticated user for themselves.
      allow create: if request.auth.uid == request.resource.data.userId;
      // A ticket can be read by an admin OR by its owner.
      // The isAdmin() check is first to allow collection queries (like count) to succeed without checking resource.data.
      allow read: if isAdmin() || (request.auth != null && request.auth.uid == resource.data.userId);
      // No one can update or delete tickets through the client.
      allow update, delete: if false;
    }
    
    match /config/{docId} {
        // Anyone can read config (e.g., site status)
        allow read: if true;
        // Only admins can write to config
        allow write: if isAdmin();
    }
  }
}
