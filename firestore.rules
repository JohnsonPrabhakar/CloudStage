
rules_version = '2';

service cloud.firestore {
  match /databases/cloudstage/documents {

    function isAdmin() {
      return request.auth.token.email == 'admin@cloudstage.in';
    }

    function isSignedIn() {
      return request.auth != null;
    }

    // ARTISTS
    match /artists/{artistId} {
      allow create: if true;
      // An artist can read/update their own profile. Admin can read/update any profile.
      allow read, update: if isSignedIn() && (request.auth.uid == artistId || isAdmin());
      // Only admin can delete artists (for rejection).
      allow delete: if isAdmin();
    }

    // EVENTS
    match /events/{eventId} {
      // READ:
      // 1. Anyone can read an 'approved' event.
      // 2. The artist who owns the event can read it, regardless of status.
      // This combined rule should allow both the homepage query and the artist dashboard query.
      allow read: if resource.data.moderationStatus == 'approved' ||
                   (isSignedIn() && request.auth.uid == resource.data.artistId);

      // CREATE:
      // An artist can create an event for themselves. The approval check is handled by the backend logic and admin dashboard.
      // This simplified rule prevents query evaluation from failing due to complexity.
      allow create: if isSignedIn() && request.resource.data.artistId == request.auth.uid;

      // UPDATE:
      // The artist can update their own event (e.g., to boost it).
      // The admin can update any event (e.g., to moderate it).
      allow update: if isSignedIn() && (request.auth.uid == resource.data.artistId || isAdmin());

      // DELETE:
      // Events cannot be deleted to preserve history.
      allow delete: if false;
    }

    // MOVIES
    match /movies/{movieId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    // TICKETS
    match /tickets/{ticketId} {
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow read: if isSignedIn() && request.auth.uid == resource.data.userId;
      allow update, delete: if false;
    }

    // CONFIG
    match /config/{docId} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}
