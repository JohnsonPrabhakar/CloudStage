
rules_version = '2';

service cloud.firestore {
  match /databases/cloudstage/documents {

    // Default deny all reads and writes
    match /{document=**} {
      allow read, write: if false;
    }

    // ARTISTS
    match /artists/{artistId} {
      // Artists can read their own profile
      allow read: if request.auth.uid == artistId;
      // Anyone can create an artist profile (registration)
      allow create: if request.auth.uid != null;
      // Artists can update their own profile, only if they are the owner
      allow update: if request.auth.uid == artistId;
      // Admins can manage artist profiles (approve/reject)
      allow update, delete: if request.auth.uid != null && request.auth.token.email == 'admin@cloudstage.in';
    }

    // EVENTS
    match /events/{eventId} {
      // An event can be read if:
      // 1. It is approved (public access)
      // 2. The logged-in user is the artist who created it (artist dashboard)
      // 3. The logged-in user is an admin
      allow read: if resource.data.moderationStatus == 'approved'
                   || request.auth.uid == resource.data.artistId
                   || (request.auth.uid != null && request.auth.token.email == 'admin@cloudstage.in');

      // An artist can create an event if they are approved
      allow create: if request.auth.uid != null && get(/databases/$(database)/documents/artists/$(request.auth.uid)).data.isApproved == true;

      // An artist can update their own event. Admin can also update (e.g. for moderation).
      allow update: if request.auth.uid == resource.data.artistId
                     || (request.auth.uid != null && request.auth.token.email == 'admin@cloudstage.in');
    }

    // TICKETS
    match /tickets/{ticketId} {
      // Any authenticated user can create a ticket
      allow create: if request.auth.uid != null;
      // A user can only read their own tickets
      allow read: if request.auth.uid == resource.data.userId;
    }

    // MOVIES
    match /movies/{movieId} {
      // All movies are public to read
      allow read: if true;
      // Only admins can create, update, or delete movies
      allow create, update, delete: if request.auth.uid != null && request.auth.token.email == 'admin@cloudstage.in';
    }

    // CONFIG
    match /config/{docId} {
        // Publicly readable, admin writeable
        allow read: if true;
        allow write: if request.auth.uid != null && request.auth.token.email == 'admin@cloudstage.in';
    }
  }
}
